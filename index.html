<!DOCTYPE html>
<html>
<head>
  <title>D4.a – Trasy Google (Łowicz)</title>
  <meta charset="utf-8" />
  <style>
    #map { height: 100vh; width: 100%; }
  </style>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDoDGbQRTKYV1T1isARxO1e5UyLZqMJrM&callback=initMap"
    async
    defer>
  </script>
    <h3>Laboratorium: 1</h3>

</head>
<body>

<div id="map"></div>

<script>
let map;
let driverPoints = [];
let passengerPoints = [];

// ================== MATEMATYKA ==================

function haversine(a, b) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const h =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function distanceToSegment(p, v, w) {
  const toRad = x => x * Math.PI / 180;
  const lat1 = toRad(v.lat), lng1 = toRad(v.lng);
  const lat2 = toRad(w.lat), lng2 = toRad(w.lng);
  const latP = toRad(p.lat), lngP = toRad(p.lng);

  const dLat = lat2 - lat1;
  const dLng = lng2 - lng1;

  if (dLat === 0 && dLng === 0) return haversine(v, p);

  const t = Math.max(0, Math.min(1,
    ((latP - lat1) * dLat + (lngP - lng1) * dLng) /
    (dLat * dLat + dLng * dLng)
  ));

  const proj = {
    lat: v.lat + t * (w.lat - v.lat),
    lng: v.lng + t * (w.lng - v.lng)
  };

  return haversine(proj, p);
}

function findCommonSegment(driver, passenger, tolerance = 15) {
  let common = [];

  passenger.forEach(p => {
    for (let i = 0; i < driver.length - 1; i++) {
      if (distanceToSegment(p, driver[i], driver[i + 1]) <= tolerance) {
        common.push(p);
        break;
      }
    }
  });

  return common;
}

// ================== MAPA ==================

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 15,
    center: { lat: 52.1065, lng: 19.951 }
  });

  loadDriverRoute();
  loadPassengerRoute();
}

function loadDriverRoute() {
  const service = new google.maps.DirectionsService();

  service.route({
    origin: { lat: 52.1076, lng: 19.9466 },
    destination: { lat: 52.1039, lng: 19.9586 },
    travelMode: 'DRIVING'
  }, (result, status) => {
    if (status === 'OK') {
      driverPoints = decodeRoute(result);
      drawPath(driverPoints, '#0066FF', 5); // NIEBIESKI
      tryCompare();
    }
  });
}

function loadPassengerRoute() {
  const service = new google.maps.DirectionsService();

  service.route({
    origin: { lat: 52.1054, lng: 19.9522 },
    destination: { lat: 52.1016, lng: 19.9604 },
    travelMode: 'DRIVING'
  }, (result, status) => {
    if (status === 'OK') {
      passengerPoints = decodeRoute(result);
      drawPath(passengerPoints, '#FF0000', 4); // CZERWONY
      tryCompare();
    }
  });
}

function decodeRoute(result) {
  const points = [];
  result.routes[0].legs[0].steps.forEach(step => {
    step.path.forEach(p => {
      points.push({ lat: p.lat(), lng: p.lng() });
    });
  });
  return points;
}

function drawPath(points, color, weight) {
  new google.maps.Polyline({
    path: points,
    geodesic: true,
    strokeColor: color,
    strokeOpacity: 1,
    strokeWeight: weight,
    map: map
  });
}

function tryCompare() {
  if (driverPoints.length && passengerPoints.length) {
    const common = findCommonSegment(driverPoints, passengerPoints);

    if (common.length > 0) {
      drawPath(common, '#00AA00', 7); // ZIELONY
      console.log("Wspólny odcinek:", common.length, "punktów");
    } else {
      console.log("Brak wspólnego odcinka");
    }
  }
}
</script>

</body>
</html>
