<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Test mapy Google</title>
    <style>
        /* Mapa zajmuje całą wysokość ekranu */
        #map {
            width: 100%;
            height: 100vh;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
    </style>
</head>
<body>

<h2>Test mapy Google 1.2.0</h2>
<div id="map"></div>

    <!-- Google Maps JS -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDoDGbQRTKYV1T1isARxO1e5UyLZqMJrM&callback=initMap&v=beta&libraries=marker" async defer></script>
    <!-- Firebase JS -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
    // 1. Firebase konfiguracja
    const firebaseConfig = {
  apiKey: "AIzaSyCob8E-nwXrsRIIS9vTZA11_ltmR5ncYZk",
  authDomain: "crossway-ed6fd.firebaseapp.com",
  databaseURL: "https://crossway-ed6fd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "crossway-ed6fd",
  storageBucket: "crossway-ed6fd.firebasestorage.app",
  messagingSenderId: "735163556486",
  appId: "1:735163556486:web:a8e5e4f666cfeda934e707",
  measurementId: "G-EMP8CK82RG"
};

// Initialize Firebase (compat)
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
    // 2. ID użytkownika (prompt)
    const userId = prompt("Podaj swoje ID: user1 lub user2");

    // zmienne globalne
    let map, userMarker, otherMarker, poly;

    // 3. Funkcja wysyłania pozycji do Firebase
    function sendPosition(lat, lng) {
        db.ref('locations/' + userId).set({
            lat: lat,
            lng: lng,
            timestamp: Date.now()
        });
    }

    // 4. Funkcja nasłuchiwania drugiego użytkownika
    function watchOtherUser() {
        const otherUser = (userId === "user1") ? "user2" : "user1";
        db.ref('locations/' + otherUser).on('value', snapshot => {
            const data = snapshot.val();
            if(data && map) {
                // usuń stary marker jeśli istnieje
                if(otherMarker) otherMarker.setMap(null);

                otherMarker = new google.maps.Marker({
                    position: {lat: data.lat, lng: data.lng},
                    map: map,
                    title: "Drugi użytkownik"
                });

                // rysowanie wspólnego odcinka
                if(userMarker) {
                    if(poly) poly.setMap(null);
                    poly = new google.maps.Polyline({
                        path: [userMarker.getPosition(), otherMarker.getPosition()],
                        geodesic: true,
                        strokeColor: "#FF0000",
                        strokeOpacity: 1.0,
                        strokeWeight: 4,
                        map: map
                    });
                }
            }
        });
    }

    // 5. Inicjalizacja mapy
    function initMap() {
        const defaultPos = { lat: 52.106247, lng: 19.944756 }; // Łowicz

        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 14,
            center: defaultPos
        });

        // sprawdzenie geolokalizacji
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const pos = {lat: position.coords.latitude, lng: position.coords.longitude};
                map.setCenter(pos);

                userMarker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: "Ty"
                });

                sendPosition(pos.lat, pos.lng);
                watchOtherUser();

                // aktualizacja pozycji co 5 sekund
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(p => {
                        const newPos = {lat: p.coords.latitude, lng: p.coords.longitude};
                        userMarker.setPosition(newPos);
                        sendPosition(newPos.lat, newPos.lng);
                    });
                }, 5000);

            }, () => {
                // jeśli brak zgody na geolokalizację → używamy domyślnej
                userMarker = new google.maps.Marker({
                    position: defaultPos,
                    map: map,
                    title: "Ty (domyślna lokalizacja)"
                });
                sendPosition(defaultPos.lat, defaultPos.lng);
                watchOtherUser();
            });
        } else {
            // jeśli brak wsparcia geolokalizacji → używamy domyślnej
            userMarker = new google.maps.Marker({
                position: defaultPos,
                map: map,
                title: "Ty (domyślna lokalizacja)"
            });
            sendPosition(defaultPos.lat, defaultPos.lng);
            watchOtherUser();
        }
    }
    </script>
</body>
</html>
